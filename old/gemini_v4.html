<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aiRekon Risk Assessment Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f5; /* Zinc 100 */
            color: #18181b; /* Zinc 900 */
        }
        .form-input, .form-select, .form-textarea {
            transition: all 0.2s ease-in-out;
            background-color: #ffffff;
            border-color: #d4d4d8; /* Zinc 300 */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6; /* Blue 500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .btn {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        .btn-primary:disabled {
            background-color: #9ca3af; /* Gray 400 */
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Gray 200 */
            color: #374151; /* Gray 700 */
            border: 1px solid #d1d5db; /* Gray 300 */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Gray 300 */
        }
        .btn-secondary:disabled {
            background-color: #f3f4f6; /* Gray 100, lighter */
            color: #9ca3af;      /* Gray 400, for text */
            border-color: #e5e7eb; /* Gray 200, lighter border */
            cursor: not-allowed;
            opacity: 0.75; /* opacity for a more faded look: 0.7->0.75 */
        }
        .table-row-new {
            background-color: #eff6ff; /* Blue 50 */
        }
        .table-row-accepted {
            background-color: #f0fdf4; /* Green 50 */
        }
        .table-cell-editing {
            background-color: white !important;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 40vh;
        }
        .loader {
            border: 4px solid #e5e7eb; /* Gray 200 */
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        #reportContainer { padding: 2rem; background-color: white; } /* For PDF export */
        .fixed-table-layout {
            table-layout: fixed;
            width: 100%;
        }
        .justification-icon-container {
            position: relative;
        }
        .justification-plus-icon {
            position: absolute;
            top: 2px; 
            right: 2px; 
            width: 18px; 
            height: 18px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; 
            font-weight: bold;
            line-height: 1;
            color: #3b82f6; /* Blue 500 */
            border: 1.5px solid #3b82f6; /* Blue 500 */
            background-color: white;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            z-index: 10;
        }
        .justification-icon-container:hover .justification-plus-icon,
        .justification-plus-icon:hover {
            opacity: 1;
            background-color: #eff6ff; /* Blue 50 */
            border-color: #2563eb; /* Blue 600 */
        }
        /* Ensure icon is visible when cell is being edited */
        .table-cell-editing .justification-plus-icon {
            opacity: 1;
        }
        /* Summary specific hover for its container */
        #summaryContentWrapper:hover .justification-plus-icon {
             opacity: 1;
        }
        #justificationPane {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background-color: white;
            border-left: 1px solid #d1d5db;
            padding: 2rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        #justificationPane.open {
            transform: translateX(0);
        }
        #justificationPane h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        #justificationPane p {
            margin-bottom: 0.5rem;
        }
        #justificationPane ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        #closeJustificationPane {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #374151;
            cursor: pointer;
        }
    </style>
</head>
<body class="text-zinc-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <div id="screen1">
            <header class="mb-8 text-center">
                <img src="airekon_reduced.png" alt="aiRekon Logo" class="mx-auto mb-4 h-16">
                <h1 class="text-2xl font-bold text-zinc-900">Create New aiRekon Risk Assessment</h1>
                <p class="mt-2 text-lg text-zinc-600">Provide the project details and documents for the AI to begin analysis.</p>
            </header>

            <div class="bg-white p-8 rounded-xl shadow-lg border border-zinc-200">
                <form id="setupForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-zinc-800 border-b pb-2">Project Information</h2>
                        <div>
                            <label for="projectName" class="block text-sm font-medium text-zinc-700 mb-1">Project Name/Identifier *</label>
                            <input type="text" id="projectName" name="projectName" class="form-input w-full rounded-md border p-2" required>
                        </div>
                        <div>
                            <label for="projectScope" class="block text-sm font-medium text-zinc-700 mb-1">Project Scope & Objectives</label>
                            <textarea id="projectScope" name="projectScope" rows="4" class="form-textarea w-full rounded-md border p-2" placeholder="e.g., Launching a new mobile banking app..."></textarea>
                        </div>
                        <div>
                            <label for="responsiblePerson" class="block text-sm font-medium text-zinc-700 mb-1">Responsible Person</label>
                            <input type="text" id="responsiblePerson" name="responsiblePerson" class="form-input w-full rounded-md border p-2">
                        </div>
                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-zinc-700 mb-1">Date of Event *</label>
                            <input type="date" id="eventDate" name="eventDate" class="form-input w-full rounded-md border p-2" required>
                        </div>
                        <div>
                            <label for="attendees" class="block text-sm font-medium text-zinc-700 mb-1">Number of Attendees (if applicable)</label>
                            <input type="number" id="attendees" name="attendees" class="form-input w-full rounded-md border p-2" min="0">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-zinc-700 mb-1">Industry/Sector</label>
                            <select id="industry" name="industry" class="form-select w-full rounded-md border p-2">
                                <option>Technology</option>
                                <option>Finance</option>
                                <option>Healthcare</option>
                                <option>Manufacturing</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-zinc-800 border-b pb-2">File Upload</h2>
                        <div>
                            <label class="block text-sm font-medium text-zinc-700 mb-1">Relevant Documents</label>
                            <div id="dropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-zinc-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-zinc-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                    <div class="flex text-sm text-zinc-600">
                                        <label for="fileUpload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                            <span>Upload a file</span>
                                            <input id="fileUpload" name="fileUpload" type="file" class="sr-only" multiple>
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-zinc-500">PDF, DOCX, XLSX up to 10MB</p>
                                </div>
                            </div>
                        </div>
                        <div id="fileList" class="space-y-2"></div>
                    </div>
                </form>

                <div class="mt-8 pt-5 border-t border-zinc-200">
                    <div class="flex justify-end">
                        <button type="button" id="generateBtn" class="btn btn-primary" disabled>
                            Generate Risk Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen2" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="goBackBtn" class="btn btn-secondary">‚Üê Back to Setup</button>
                <h1 id="reportScreenTitle" class="text-2xl font-bold text-zinc-900 text-center flex-grow"></h1>
                <div class="w-32"></div> </div>
            
            <div class="mt-4 bg-zinc-100 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-medium text-zinc-600">AI STATUS</h2>
                    <span id="aiStatus" class="text-sm font-semibold text-blue-600">Initializing...</span>
                </div>
                <div class="w-full bg-zinc-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
                </div>
            </div>

            <div id="reportContainer" class="bg-white p-8 rounded-xl shadow-lg border border-zinc-200">
                <h2 id="reportTitle" class="text-2xl font-bold text-zinc-900 mb-6 text-center"></h2>
                
                <div id="summarySection" class="mb-8 hidden">
                    <h3 class="text-xl font-semibold text-zinc-800 mb-3">Contextual Summary</h3>
                    <div id="summaryContentWrapper" class="relative">
                        <div id="summaryContent" class="text-zinc-700 leading-relaxed p-4 rounded-md bg-zinc-50 border border-zinc-200" contenteditable="false"></div>
                        <span class="justification-plus-icon" id="summaryJustificationIcon" title="View Justification">+</span>
                    </div>
                    <div id="summaryActions" class="mt-4 flex items-center gap-4 hidden">
                        <button id="acceptSummaryBtn" class="text-sm font-semibold text-green-600 hover:text-green-800 transition">‚úî Accept</button>
                        <button id="editSummaryBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition">‚úèÔ∏è Edit</button>
                        <button id="saveSummaryBtn" class="hidden text-sm font-semibold text-blue-600 hover:text-blue-800 transition">üíæ Save</button>
                    </div>
                </div>

                <div id="riskTableSection" class="hidden">
                    <h3 class="text-xl font-semibold text-zinc-800 mb-4">Detailed Risk Assessment</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-zinc-200 fixed-table-layout">
                            <thead class="bg-zinc-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 25%;">Risk Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 12%;">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 7%;">Impact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 8%;">Likelihood</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 8%;">Overall</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 28%;">Mitigations</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-500 uppercase tracking-wider" style="width: 12%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="riskTableBody" class="bg-white divide-y divide-zinc-200">
                                </tbody>
                        </table>
                        <div id="tableLoader" class="flex justify-center items-center py-8 hidden">
                            <div class="loader"></div>
                            <p class="ml-4 text-zinc-500">AI is analyzing risks...</p>
                        </div>
                        <div id="acceptAllContainer" class="mt-4 flex justify-end hidden">
                            <button id="acceptAllBtn" class="btn btn-secondary">Accept All</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end">
                <button id="exportBtn" class="btn btn-primary" disabled>Export to PDF</button>
            </div>
        </div>

        <div id="justificationPane" class="hidden fixed top-0 right-0 h-full w-full md:w-1/3 bg-zinc-50 shadow-2xl p-6 z-50 overflow-y-auto border-l border-zinc-300" style="transition: transform 0.3s ease-in-out; transform: translateX(100%);">
            <div class="flex justify-between items-center mb-6">
                <button id="closeJustificationPaneBtn" class="text-zinc-600 hover:text-zinc-800 text-3xl font-light">&times;</button>
                <h2 id="justificationFieldName"></h2>
            </div>
            <p id="justificationFieldValue"></p>
            <h3>Reasoning:</h3>
            <p id="justificationReasoning"></p>
            <h3>Sources:</h3>
            <ul id="justificationSources"></ul>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const screen1 = document.getElementById('screen1');
            const screen2 = document.getElementById('screen2');
            const setupForm = document.getElementById('setupForm');
            const projectNameInput = document.getElementById('projectName');
            const responsiblePersonInput = document.getElementById('responsiblePerson');
            const eventDateInput = document.getElementById('eventDate');
            const attendeesInput = document.getElementById('attendees');
            const generateBtn = document.getElementById('generateBtn');
            
            const reportScreenTitle = document.getElementById('reportScreenTitle');
            const reportTitle = document.getElementById('reportTitle');
            const aiStatus = document.getElementById('aiStatus');
            const progressBar = document.getElementById('progressBar');
            const goBackBtn = document.getElementById('goBackBtn');
            
            const reportContainer = document.getElementById('reportContainer');
            const summarySection = document.getElementById('summarySection');
            const summaryContentWrapper = document.getElementById('summaryContentWrapper');
            const summaryContent = document.getElementById('summaryContent');
            const summaryActions = document.getElementById('summaryActions');
            const acceptSummaryBtn = document.getElementById('acceptSummaryBtn');
            const editSummaryBtn = document.getElementById('editSummaryBtn');
            const saveSummaryBtn = document.getElementById('saveSummaryBtn');
            const summaryJustificationIcon = document.getElementById('summaryJustificationIcon');

            const riskTableSection = document.getElementById('riskTableSection');
            const tableLoader = document.getElementById('tableLoader');
            const riskTableBody = document.getElementById('riskTableBody');
            
            const exportBtn = document.getElementById('exportBtn');
            const acceptAllContainer = document.getElementById('acceptAllContainer');
            const acceptAllBtn = document.getElementById('acceptAllBtn');

            const dropZone = document.getElementById('dropZone');
            const fileUpload = document.getElementById('fileUpload');
            const fileList = document.getElementById('fileList');

            const justificationPane = document.getElementById('justificationPane');
            const closeJustificationPane = document.getElementById('closeJustificationPaneBtn');
            const justificationFieldName = document.getElementById('justificationFieldName');
            const justificationFieldValue = document.getElementById('justificationFieldValue');
            const justificationReasoning = document.getElementById('justificationReasoning');
            const justificationSources = document.getElementById('justificationSources');
            const closeJustificationPaneBtn = document.getElementById('closeJustificationPaneBtn');

            // --- State ---
            let riskData = [];
            let currentProjectName = "";
            let aiRekonLogoBase64 = null; // To store the base64 logo for PDF

            // --- Preload logo for PDF ---
            const preloadLogo = () => {
                return new Promise((resolve, reject) => {
                    try {
                        console.log('Attempting to load logo: aiRekon logo.jpeg');
                        
                        // Create an image element
                        const img = new Image();
                        img.crossOrigin = 'anonymous'; // This might help in some cases
                        
                        // Set up event handlers
                        img.onload = function() {
                            console.log('Logo loaded successfully, converting to base64...');
                            
                            // Create a canvas and draw the image
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            // Convert to base64
                            try {
                                const base64 = canvas.toDataURL('image/jpeg', 0.9); // 0.9 for good quality
                                console.log('Logo converted to base64, length:', base64.length);
                                aiRekonLogoBase64 = base64;
                                resolve(base64);
                            } catch (e) {
                                console.error('Error converting image to base64:', e);
                                reject('Failed to convert image to base64');
                            }
                        };
                        
                        img.onerror = function() {
                            console.error('Failed to load logo image');
                            reject('Failed to load logo image');
                        };
                        
                        // Start loading the image
                        // Use a relative path
                        img.src = 'aiRekon logo.jpeg';
                        
                    } catch (error) {
                        console.error('Error in preloadLogo function:', error);
                        reject('Error in preloadLogo function');
                    }
                });
            };

            // Alternative: Embed logo as base64 directly (fallback if canvas method fails)
            // You can convert your logo to base64 using an online tool and paste it here
            const FALLBACK_LOGO_BASE64 = null; // Set this if needed
            
            // Attempt to preload the logo when the script loads, but don't block anything.
            // The actual export will ensure it waits.
            preloadLogo().catch(err => console.warn("Initial logo preload failed, will retry on export:", err));

            // --- Mock Data ---
            const MOCK_SUMMARY_TEMPLATE = `<p class="mb-4">This risk assessment addresses '{projectName}', a {projectType} scheduled for {eventDate}. {attendeesInfo}The project's primary objectives revolve around {projectScopeInfo}. Key operational considerations include {projectNature}.</p>
             <p>Reflecting on common patterns in similar initiatives, challenges such as resource allocation, timeline adherence, and stakeholder communication have historically been areas requiring attention. For '{projectName}', it is therefore prudent to establish robust planning for these aspects, ensuring that potential ancillaries are anticipated and contingency measures are in place. This proactive stance will be instrumental in mitigating common pitfalls and steering the project towards its intended success.</p>`;
            const MOCK_RISKS = [
                { id: 1, risk: "Unauthorized access to customer financial data due to weak authentication protocols.", category: "Cybersecurity", impact: 5, likelihood: 3, mitigation: "Implement multi-factor authentication (MFA), enforce strong password policies, and conduct regular penetration testing." },
                { id: 2, risk: "Denial-of-Service (DoS) attack overwhelming server resources and causing system outage.", category: "Cybersecurity", impact: 4, likelihood: 4, mitigation: "Utilize a cloud-based DDoS mitigation service, implement rate limiting, and ensure scalable infrastructure." },
                { id: 3, risk: "Failure to comply with PCI-DSS requirements leading to potential fines and reputational damage.", category: "Compliance", impact: 5, likelihood: 2, mitigation: "Conduct regular third-party audits against PCI-DSS, train staff on compliance, and maintain detailed documentation." },
                { id: 4, risk: "System instability or failure during peak transaction volumes due to inadequate capacity planning.", category: "Operational", impact: 4, likelihood: 3, mitigation: "Perform comprehensive load testing, implement auto-scaling for cloud resources, and optimize database queries." },
                { id: 5, risk: "Significant data loss or corruption due to hardware failure, software bugs, or ransomware attack.", category: "Operational", impact: 5, likelihood: 2, mitigation: "Establish automated, frequent backups to geographically separate and immutable storage. Regularly test data recovery procedures." },
                { id: 6, risk: "Successful phishing attacks targeting employees leading to compromised credentials or malware infection.", category: "Cybersecurity", impact: 4, likelihood: 4, mitigation: "Mandatory, ongoing security awareness training for all employees, deploy advanced email filtering, and implement endpoint detection and response (EDR)." },
            ];

            // --- Form & File Upload Logic ---
            const validateForm = () => {
                generateBtn.disabled = !projectNameInput.value.trim() || !eventDateInput.value;
            };

            projectNameInput.addEventListener('input', validateForm);
            eventDateInput.addEventListener('input', validateForm);

            const handleFiles = (files) => {
                fileList.innerHTML = '';
                for (const file of files) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'flex items-center justify-between bg-zinc-100 p-2 rounded-md text-sm';
                    fileDiv.innerHTML = `
                        <span>${file.name}</span>
                        <button class="text-red-500 hover:text-red-700">&times;</button>
                    `;
                    fileDiv.querySelector('button').onclick = () => fileDiv.remove();
                    fileList.appendChild(fileDiv);
                }
            };
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); handleFiles(e.dataTransfer.files); });
            fileUpload.addEventListener('change', (e) => handleFiles(e.target.files));

            const resetScreen2 = () => {
                riskData = [];
                
                summaryContent.textContent = '';
                summarySection.classList.add('hidden');
                summaryActions.classList.add('hidden');
                acceptSummaryBtn.innerHTML = '‚úî Accept';
                acceptSummaryBtn.disabled = false;
                editSummaryBtn.classList.remove('hidden');
                saveSummaryBtn.classList.add('hidden');
                summaryContent.contentEditable = false;
                summaryContent.classList.remove('table-cell-editing');

                riskTableBody.innerHTML = '';
                riskTableSection.classList.add('hidden');
                
                progressBar.style.width = '0%';
                aiStatus.textContent = 'Initializing...';
                exportBtn.disabled = true;
                acceptAllContainer.classList.add('hidden');
                acceptAllBtn.disabled = false;
            };

            goBackBtn.addEventListener('click', () => {
                screen2.classList.add('hidden');
                screen1.classList.remove('hidden');
                resetScreen2();
            });

            // --- Simulation Logic ---
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const proceedToRiskGeneration = async () => {
                riskTableSection.classList.remove('hidden');
                riskTableSection.classList.add('fade-in');
                tableLoader.classList.remove('hidden');
                aiStatus.textContent = `Analyzing risks...`;
                
                let currentProgress = parseFloat(progressBar.style.width) || 20;
                const totalRisks = MOCK_RISKS.length;
                const progressForRisks = 80;
                const progressIncrement = totalRisks > 0 ? (progressForRisks / totalRisks) : progressForRisks;

                for (let i = 0; i < totalRisks; i++) {
                    const risk = MOCK_RISKS[i];
                    currentProgress += progressIncrement;
                    progressBar.style.width = `${Math.min(currentProgress, 100)}%`;
                    aiStatus.textContent = `Generating Risk Item ${i + 1} of ${totalRisks}`;
                    await sleep(800);
                    addRiskRow(risk);
                    riskData.push({...risk});
                }
                
                tableLoader.classList.add('hidden');
                
                progressBar.style.width = '100%';
                aiStatus.textContent = "Generation Complete. Review & Export.";
                exportBtn.disabled = false;
                if (riskData.length > 0) {
                    acceptAllContainer.classList.remove('hidden');
                    acceptAllContainer.classList.add('fade-in');
                }
            };

            const startGeneration = async () => {
                currentProjectName = projectNameInput.value.trim();
                screen1.classList.add('hidden');
                reportScreenTitle.textContent = `aiRekon Automated Risk Assessment`;

                let eventDateFormatted = 'N/A';
                if (eventDateInput.value) {
                    const dateParts = eventDateInput.value.split('-'); // YYYY-MM-DD
                    if (dateParts.length === 3) {
                        eventDateFormatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0].slice(-2)}`;
                    }
                }
                reportTitle.textContent = `Risk Assessment Report for: ${currentProjectName} on ${eventDateFormatted}`;
                screen2.classList.remove('hidden');
                resetScreen2();

                aiStatus.textContent = "Generating Initial Summary...";
                progressBar.style.width = '10%';
                await sleep(1000);
                
                const eventDateValue = eventDateInput.value ? new Date(eventDateInput.value).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'an unspecified date';
                const industryValue = document.getElementById('industry').value || 'general';
                const scopeValue = document.getElementById('projectScope').value.trim();
                const attendeesNumValue = attendeesInput.value;

                let attendeesString = "";
                if (attendeesNumValue && parseInt(attendeesNumValue) > 0) {
                    attendeesString = `It is anticipated to involve approximately ${attendeesNumValue} attendees. `;
                } else {
                    attendeesString = "The scale of attendance is not specified. ";
                }

                const projectScopeString = scopeValue ? scopeValue : "achieving its stated goals as outlined in the project documentation";
                const projectNatureString = scopeValue ? `the specifics of '${scopeValue.substring(0, 50)}${scopeValue.length > 50 ? '...' : ''}' and the context of the ${industryValue} sector` : `its general operational requirements and the context of the ${industryValue} sector`;

                let dynamicSummary = MOCK_SUMMARY_TEMPLATE
                    .replace(/{projectName}/g, currentProjectName)
                    .replace(/{projectType}/g, `${industryValue} initiative`)
                    .replace(/{eventDate}/g, eventDateValue)
                    .replace(/{attendeesInfo}/g, attendeesString)
                    .replace(/{projectScopeInfo}/g, projectScopeString)
                    .replace(/{projectNature}/g, projectNatureString);

                summarySection.classList.remove('hidden');
                summarySection.classList.add('fade-in');
                summaryContent.innerHTML = dynamicSummary;
                summaryActions.classList.remove('hidden');
                progressBar.style.width = '20%';

                aiStatus.textContent = "Awaiting summary review...";
            };

            generateBtn.addEventListener('click', startGeneration);

            // --- Summary Actions ---
            acceptSummaryBtn.addEventListener('click', async () => {
                summaryContent.classList.remove('table-cell-editing');
                summaryContent.contentEditable = false;
                acceptSummaryBtn.innerHTML = '‚úî Accepted';
                acceptSummaryBtn.disabled = true;
                editSummaryBtn.classList.add('hidden');
                saveSummaryBtn.classList.add('hidden');

                await proceedToRiskGeneration();
            });

            editSummaryBtn.addEventListener('click', () => {
                summaryContent.contentEditable = true;
                summaryContent.classList.add('table-cell-editing');
                summaryContent.focus();
                editSummaryBtn.classList.add('hidden');
                saveSummaryBtn.classList.remove('hidden');
            });

            saveSummaryBtn.addEventListener('click', () => {
                summaryContent.contentEditable = false;
                summaryContent.classList.remove('table-cell-editing');
                editSummaryBtn.classList.remove('hidden');
                saveSummaryBtn.classList.add('hidden');
            });

            // --- Accept All Risks ---
            acceptAllBtn.addEventListener('click', () => {
                const rows = riskTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    // Check if not already accepted by looking for the "Accepted" span
                    const actionsCell = row.cells[row.cells.length - 1]; // Last cell is Actions
                    if (!actionsCell.querySelector('span.text-green-700')) {
                        row.classList.remove('table-row-new');
                        row.classList.add('table-row-accepted');
                        actionsCell.innerHTML = '<span class="text-sm text-green-700 font-semibold">Accepted</span>';
                    }
                });
                acceptAllBtn.disabled = true;
                // Optionally hide the button after clicking
                // acceptAllContainer.classList.add('hidden');
            });            

            // --- Table & Chart Logic ---
            const getScoreColor = (score) => {
                if (score >= 15) return 'bg-red-100 text-red-800';
                if (score >= 8) return 'bg-yellow-100 text-yellow-800';
                return 'bg-green-100 text-green-800';
            };

            const addRiskRow = (risk) => {
                const row = document.createElement('tr');
                row.className = 'table-row-new fade-in';
                row.dataset.id = risk.id;
                const overallScore = risk.impact * risk.likelihood;

                // Helper to create content with justification icon
                const createCellContent = (content, fieldName, riskId, isNumeric = false) => {
                    let displayContent = content;
                    // Ensure N/A is used for undefined/null/empty numeric fields, otherwise convert numbers to string
                    if (isNumeric) {
                        displayContent = (content === undefined || content === null || content.toString().trim() === '') ? 'N/A' : content.toString();
                    } else if (content === undefined || content === null) {
                        displayContent = ''; // Default to empty string for non-numeric if undefined/null
                    }

                    return `<div>${displayContent}</div><span class="justification-plus-icon" data-field-name="${fieldName}" data-risk-id="${riskId}" title="View Justification">+</span>`;
                };

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-normal text-sm justification-icon-container" data-field="risk">
                        ${createCellContent(risk.risk, 'Risk Description', risk.id)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm justification-icon-container" data-field="category">
                        ${createCellContent(risk.category, 'Category', risk.id)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm justification-icon-container" data-field="impact">
                        ${createCellContent(risk.impact, 'Impact', risk.id, true)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm justification-icon-container" data-field="likelihood">
                        ${createCellContent(risk.likelihood, 'Likelihood', risk.id, true)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold justification-icon-container" data-field="overall-container">
                        <div><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getScoreColor(overallScore)}" data-field="overall">${overallScore}</span></div>
                        <span class="justification-plus-icon" data-field-name="Overall Score" data-risk-id="${risk.id}" title="View Justification">+</span>
                    </td>
                    <td class="px-6 py-4 whitespace-normal text-sm text-zinc-600 justification-icon-container" data-field="mitigation">
                        ${createCellContent(risk.mitigation, 'Mitigations', risk.id)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center gap-2">
                            <button class="text-green-600 hover:text-green-800 text-lg" data-action="accept" title="Accept">‚úî</button>
                            <button class="text-blue-600 hover:text-blue-800 text-lg" data-action="edit" title="Edit">‚úèÔ∏è</button>
                            <button class="text-red-600 hover:text-red-800 text-lg" data-action="delete" title="Delete">üóëÔ∏è</button>
                            <button class="hidden text-blue-600 hover:text-blue-800 text-lg" data-action="save" title="Save">üíæ</button>
                        </div>
                    </td>
                `;
                riskTableBody.appendChild(row);
            };
            
            riskTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                const justificationIcon = e.target.closest('.justification-plus-icon');

                if (justificationIcon) {
                    const fieldName = justificationIcon.dataset.fieldName;
                    const riskId = parseInt(justificationIcon.dataset.riskId, 10);
                    const currentRisk = riskData.find(r => r.id === riskId);
                    
                    let fieldValue = 'N/A'; 
                    let reasoning;
                    let sources;

                    // Attempt to get fieldValue from the DOM element first
                    const contentWrapper = justificationIcon.previousElementSibling;
                    if (contentWrapper) {
                        fieldValue = (contentWrapper.textContent || contentWrapper.innerText || 'N/A').trim();
                    }

                    if (currentRisk) {
                        if (fieldName === 'Overall Score') {
                            const overall = (currentRisk.impact * currentRisk.likelihood);
                            fieldValue = overall.toString(); // Ensure fieldValue is accurate for display
                            reasoning = `The Overall Score (${overall}) is calculated by multiplying Impact (${currentRisk.impact}) by Likelihood (${currentRisk.likelihood}).`;
                            sources = ['Risk Scoring Matrix', 'Internal Calculation Logic'];
                        } else {
                            // For other fields, get fieldValue from currentRisk if not already found or to ensure accuracy
                            if (fieldName === 'Risk Description') fieldValue = currentRisk.risk;
                            else if (fieldName === 'Category') fieldValue = currentRisk.category;
                            else if (fieldName === 'Impact') fieldValue = currentRisk.impact.toString();
                            else if (fieldName === 'Likelihood') fieldValue = currentRisk.likelihood.toString();
                            else if (fieldName === 'Mitigations') fieldValue = currentRisk.mitigation;
                            // else fieldValue remains what was grabbed from contentWrapper or default 'N/A'

                            // Set detailed placeholder reasoning and sources for these other fields
                            reasoning = `The value for "${fieldName}" (risk ID: ${riskId}) was determined based on an algorithmic assessment of the input documents and established risk ontologies for this sector. Specific keywords and contextual phrases related to potential threats and vulnerabilities were identified and scored. For numeric values, this involved a quantitative model considering frequency and potential severity. For textual descriptions, generative models summarized identified risk factors and proposed standard mitigation techniques.`;
                            sources = ['Uploaded Document Example.pdf', 'Risk Analysis Model v3.1 Output', 'General Industry Best Practices'];
                        }
                    } else {
                        // Fallback if currentRisk is not found (e.g. if data is somehow corrupt or ID is wrong)
                        reasoning = `Justification for "${fieldName}" (risk ID: ${riskId}) could not be fully determined as the specific risk data was not found. This value is based on general UI display.`;
                        sources = ['UI Display Data'];
                    }

                    openJustificationPane(fieldName, fieldValue, reasoning, sources);
                    return; 
                }

                if (!button) return;

                const action = button.dataset.action;
                const row = button.closest('tr');
                const id = parseInt(row.dataset.id, 10);
                const riskItem = riskData.find(r => r.id === id);
                
                if (action === 'accept') {
                    row.classList.remove('table-row-new');
                    row.classList.add('table-row-accepted');
                    button.parentElement.innerHTML = '<span class="text-sm text-green-700 font-semibold">Accepted</span>';
                } else if (action === 'delete') {
                    if (confirm('Are you sure you want to delete this risk?')) {
                        row.remove();
                        riskData = riskData.filter(r => r.id !== id);
                    }
                } else if (action === 'edit') {
                    row.querySelectorAll('[data-field]').forEach(cell => {
                        if (['risk', 'category', 'impact', 'likelihood', 'mitigation'].includes(cell.dataset.field)) {
                            cell.contentEditable = true;
                            cell.classList.add('table-cell-editing');
                        }
                    });
                    row.querySelector('[data-action="edit"]').classList.add('hidden');
                    row.querySelector('[data-action="accept"]').classList.add('hidden');
                    row.querySelector('[data-action="delete"]').classList.add('hidden');
                    row.querySelector('[data-action="save"]').classList.remove('hidden');
                } else if (action === 'save') {
                    row.querySelectorAll('[data-field]').forEach(cell => {
                        cell.contentEditable = false;
                        cell.classList.remove('table-cell-editing');
                    });
                    
                    if (riskItem) {
                         riskItem.risk = row.querySelector('[data-field="risk"]').textContent;
                         riskItem.category = row.querySelector('[data-field="category"]').textContent;
                         riskItem.impact = parseInt(row.querySelector('[data-field="impact"]').textContent, 10) || riskItem.impact;
                         riskItem.likelihood = parseInt(row.querySelector('[data-field="likelihood"]').textContent, 10) || riskItem.likelihood;
                         riskItem.mitigation = row.querySelector('[data-field="mitigation"]').textContent;
                         
                         const newOverall = riskItem.impact * riskItem.likelihood;
                         const overallCell = row.querySelector('[data-field="overall"]');
                         overallCell.textContent = newOverall;
                         overallCell.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getScoreColor(newOverall)}`;
                    }
                    
                    row.querySelector('[data-action="edit"]').classList.remove('hidden');
                    row.querySelector('[data-action="accept"]').classList.remove('hidden');
                    row.querySelector('[data-action="delete"]').classList.remove('hidden');
                    row.querySelector('[data-action="save"]').classList.add('hidden');
                }
            });

            // --- Justification Pane Logic ---
            const openJustificationPane = (fieldName, fieldValue, reasoning, sources) => {
                justificationFieldName.textContent = fieldName;

                if (fieldName === 'Contextual Summary') {
                    justificationFieldValue.innerHTML = ''; // Clear content
                    justificationFieldValue.style.display = 'none'; // Hide the element
                } else {
                    justificationFieldValue.textContent = fieldValue; // Set text for other fields
                    justificationFieldValue.style.display = ''; // Ensure element is visible and reset display property
                }

                justificationReasoning.textContent = reasoning;
                justificationSources.innerHTML = '';
                if (sources && sources.length > 0) {
                    sources.forEach(src => {
                        const li = document.createElement('li');
                        li.textContent = src;
                        justificationSources.appendChild(li);
                    });
                } else {
                    justificationSources.innerHTML = '<li>No specific documents cited.</li>';
                }
                justificationPane.classList.remove('hidden');
                setTimeout(() => {
                    justificationPane.style.transform = 'translateX(0)';
                }, 10); 
            };

            const hideJustificationPaneAndResetTransform = () => {
                justificationPane.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    justificationPane.classList.add('hidden');
                }, 300); // Matches transition duration
            };

            if (closeJustificationPaneBtn) {
                console.log("Close Justification Pane button (id='closeJustificationPaneBtn') found, attaching listener."); // Diagnostic log
                closeJustificationPaneBtn.addEventListener('click', hideJustificationPaneAndResetTransform);
            } else {
                console.error("Error: Close Justification Pane button with id='closeJustificationPaneBtn' NOT found. Please check the button ID in your HTML."); // Diagnostic log
            }

            summaryJustificationIcon.addEventListener('click', () => {
                openJustificationPane(
                    'Contextual Summary',
                    summaryContent.innerHTML,
                    'The summary was generated based on the project details provided and a comprehensive analysis of similar initiatives in the industry. It provides an overview of the event characteristics and historical context, highlighting key considerations for the current project.',
                    ['Project Details', 'Industry Best Practices', 'Historical Data']
                );
            });

            // --- PDF Export Logic ---
            const exportToPDF = async () => {
                exportBtn.disabled = true;
                exportBtn.textContent = 'Generating PDF...';

                let localLogoBase64 = aiRekonLogoBase64; // Use the preloaded logo
                if (!localLogoBase64) {
                    try {
                        console.log('Logo not preloaded, attempting to load now for PDF export...');
                        localLogoBase64 = await preloadLogo();
                        console.log('Logo loaded successfully for PDF export.');
                    } catch (error) {
                        console.error('Failed to load logo for PDF export, will use fallback text:', error);
                    }
                }

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight(); // Full page height
                const marginLeft = 15;
                const marginRight = 15;
                const marginTop = 15;
                const footerHeight = 20; // Estimated footer height for page break calculation
                const contentWidth = pageWidth - marginLeft - marginRight;

                let currentY = marginTop;

                const addHeader = () => {
                    const logoWidth = 40;
                    const logoHeight = 15;
                    const logoX = marginLeft;
                    const logoY = marginTop;

                    if (localLogoBase64) {
                        try {
                            pdf.addImage(localLogoBase64, 'JPEG', logoX, logoY, logoWidth, logoHeight);
                        } catch (e) {
                            console.error("Error adding logo to PDF:", e);
                            pdf.setFontSize(10);
                            pdf.setTextColor(150, 150, 150);
                            pdf.text("aiRekon", marginLeft, marginTop + 5);
                        }
                    } else {
                        pdf.setFontSize(10);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text("aiRekon", marginLeft, marginTop + 5);
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont(undefined, 'bold');
                    pdf.text("Risk Assessment Report", pageWidth / 2, marginTop + 10, { align: 'center' });

                    const currentDate = new Date();
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const year = String(currentDate.getFullYear()).slice(-2);
                    const seconds = String(currentDate.getSeconds()).padStart(2, '0');
                    const createdDateFormatted = `${day}/${month}/${year}`;
                    const projectNameSanitized = currentProjectName.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 5);
                    const raNumber = `${projectNameSanitized}-${year}${month}${day}-${seconds}`;
                    
                    pdf.setFontSize(9);
                    pdf.setTextColor(100, 100, 100);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`Date: ${createdDateFormatted}`, pageWidth - marginRight, marginTop + 5, { align: 'right' });
                    pdf.text(`RA Number: ${raNumber}`, pageWidth - marginRight, marginTop + 10, { align: 'right' });
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(marginLeft, marginTop + 20, pageWidth - marginRight, marginTop + 20);
                    currentY = marginTop + 30;
                };

                const addFooter = () => {
                    const pageCount = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(9);
                        pdf.setTextColor(128);
                        pdf.text(
                            `Page ${i} of ${pageCount} | aiRekon Automated Risk Assessment`,
                            pageWidth / 2,
                            pdf.internal.pageSize.getHeight() - (footerHeight / 2) - 5, // Adjust position slightly from bottom
                            { align: 'center' }
                        );
                    }
                };

                const checkPageBreak = (requiredSpace) => {
                    // Consider usable height, subtracting top margin and footer reserve area
                    if (currentY + requiredSpace > pdf.internal.pageSize.getHeight() - footerHeight - marginTop) {
                        pdf.addPage();
                        addHeader(); // This re-applies header and resets currentY
                    }
                };

                addHeader(); // Initial header for the first page

                // Project Details Section
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('Project Details', marginLeft, currentY);
                currentY += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                const projectInfo = [
                    `Project Name: ${currentProjectName || 'N/A'}`,
                    `Responsible Person: ${responsiblePersonInput.value.trim() || 'N/A'}`,
                    `Date of Event: ${eventDateInput.value ? new Date(eventDateInput.value).toLocaleDateString('en-GB') : 'N/A'}`,
                    `Number of Attendees: ${attendeesInput.value || 'N/A'}`,
                    `Industry/Sector: ${document.getElementById('industry').value || 'N/A'}`,
                    // Scope can be long, handle it carefully
                ];
                projectInfo.forEach(detail => {
                    checkPageBreak(5);
                    const lines = pdf.splitTextToSize(detail, contentWidth);
                    lines.forEach(line => {
                         checkPageBreak(5);
                         pdf.text(line, marginLeft, currentY);
                         currentY += 5;
                    })
                });
                const projectScopeText = document.getElementById('projectScope').value.trim() || 'N/A';
                if (projectScopeText !== 'N/A') {
                    checkPageBreak(10); // Space before scope
                    pdf.text('Project Scope & Objectives:', marginLeft, currentY);
                    currentY +=5;
                    const scopeLines = pdf.splitTextToSize(projectScopeText, contentWidth);
                    scopeLines.forEach(line => {
                        checkPageBreak(5);
                        pdf.text(line, marginLeft, currentY);
                        currentY += 5;
                    });
                }
                currentY += 10;

                // Report For Title Section
                let pdfEventDateFormatted = 'N/A';
                if (eventDateInput.value) {
                    const dateParts = eventDateInput.value.split('-');
                    if (dateParts.length === 3) {
                        pdfEventDateFormatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0].slice(-2)}`;
                    }
                }
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                const reportForText = `Report for: ${currentProjectName} on ${pdfEventDateFormatted}`;
                const reportForLines = pdf.splitTextToSize(reportForText, contentWidth);
                checkPageBreak(reportForLines.length * 7 + 8); // Estimate space for title lines + bottom margin
                pdf.text(reportForLines, marginLeft, currentY);
                currentY += reportForLines.length * 7 + 8; 

                // Contextual Summary Section
                if (summaryContent.children.length > 0) {
                    checkPageBreak(15); 
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(13);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Contextual Summary', marginLeft, currentY);
                    currentY += 8;

                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    const paragraphs = summaryContent.children;
                    for (let i = 0; i < paragraphs.length; i++) {
                        const pElement = paragraphs[i];
                        const paragraphText = (pElement.textContent || "").trim();
                        if (!paragraphText) continue;

                        const paragraphLines = pdf.splitTextToSize(paragraphText, contentWidth);
                        for (const line of paragraphLines) {
                            checkPageBreak(6);
                            pdf.text(line, marginLeft, currentY);
                            currentY += 6;
                        }
                        // Add a small gap after each paragraph, except the last one within this block if followed by more summary
                        if (i < paragraphs.length - 1) {
                             let nextNonEmpty = false;
                             for (let j = i + 1; j < paragraphs.length; j++) {
                                 if ((paragraphs[j].textContent || "").trim()) {
                                     nextNonEmpty = true;
                                     break;
                                 }
                             }
                             if (nextNonEmpty) {
                                checkPageBreak(4);
                                currentY += 4; // Space between paragraphs
                             }
                        }
                    }
                    currentY += 8; // Space after the whole summary section
                }

                // Detailed Risk Assessment Table Section
                if (riskData.length > 0) {
                    checkPageBreak(20); 
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(13);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Detailed Risk Assessment', marginLeft, currentY);
                    currentY += 7;

                    const tableBodyData = riskData.map(risk => {
                        const overallScore = risk.impact * risk.likelihood;
                        return [
                            risk.risk,
                            risk.category,
                            risk.impact.toString(),
                            risk.likelihood.toString(),
                            overallScore.toString(),
                            risk.mitigation
                        ];
                    });

                    pdf.autoTable({
                        startY: currentY,
                        head: [['Risk Description', 'Category', 'Impact', 'Likelihood', 'Overall Score', 'Mitigations']],
                        body: tableBodyData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [22, 78, 99],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 9,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 8,
                            cellPadding: 2,
                            font: undefined, // Use default font
                            textColor: [0,0,0]
                        },
                        columnStyles: {
                            0: { cellWidth: 'auto', minCellWidth: 40 },
                            1: { cellWidth: 20, halign: 'center' },
                            2: { cellWidth: 15, halign: 'center' },
                            3: { cellWidth: 20, halign: 'center' },
                            4: { cellWidth: 18, halign: 'center' },
                            5: { cellWidth: 'auto', minCellWidth: 45 }
                        },
                        didParseCell: function(data) {
                            if (data.column.index === 4 && data.row.section === 'body') {
                                const score = parseInt(data.cell.raw.toString());
                                if (score >= 15) {
                                    data.cell.styles.fillColor = [254, 226, 226]; 
                                    data.cell.styles.textColor = [153, 27, 27]; 
                                } else if (score >= 8) {
                                    data.cell.styles.fillColor = [254, 243, 199]; 
                                    data.cell.styles.textColor = [146, 64, 14]; 
                                } else {
                                    data.cell.styles.fillColor = [220, 252, 231]; 
                                    data.cell.styles.textColor = [22, 101, 52]; 
                                }
                                data.cell.styles.fontStyle = 'bold';
                            }
                        },
                        margin: { left: marginLeft, right: marginRight }, // Top margin is handled by startY
                        didDrawPage: (data) => {
                            // If a new page was added by autoTable, we need to re-apply our header
                            // and update currentY for subsequent content.
                            // Check if it's not the first page of the table.
                            // data.pageNumber gives current page in PDF, data.settings.pageCount gives total pages for table
                            if (data.pageNumber > 1 && data.cursor.y < marginTop + 30) { // Heuristic: if Y is low, new page
                                addHeader();
                            }
                        }
                    });
                    currentY = pdf.lastAutoTable.finalY + 10;
                }

                addFooter(); // Add footers to all pages

                pdf.save(`${currentProjectName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_risk_assessment.pdf`);
                
                exportBtn.disabled = false;
                exportBtn.textContent = 'Export to PDF';
            };

            exportBtn.addEventListener('click', exportToPDF);
        });
    </script>
</body>
</html>